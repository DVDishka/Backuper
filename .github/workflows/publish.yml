name: Publish to Modrinth (Direct API)

on:
  release:
    types: [published]

jobs:
  publish-modrinth:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading JAR for tag ${{ github.event.release.tag_name }}"
          gh release download ${{ github.event.release.tag_name }} \
            --pattern "Backuper-*.jar" \
            --dir ./target

          FILE=$(ls target/Backuper-*.jar)
          if [ -z "$FILE" ]; then
            echo "Error: JAR file not found!"
            exit 1
          fi

          echo "JAR_FILE=$FILE" >> $GITHUB_ENV
          echo "Downloaded files:"
          ls -lh ./target/

      - name: Create Modrinth version
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
          JAR_FILE: ${{ env.JAR_FILE }}
        run: |
          PROJECT_SLUG="backuper"
          VERSION_NAME="${GITHUB_REF_NAME}"  # можно использовать тег GitHub
          CHANGELOG="${{ github.event.release.body }}"
          LOADERS='["paper","purpur","folia"]'
          GAME_VERSIONS='["1.21.10","1.21.9","1.21.8","1.21.7","1.21.6","1.21.5","1.21.4","1.21.3","1.21.2","1.21.1","1.21","1.20.6"]'

          echo "Creating Modrinth version..."
          RESPONSE=$(curl -s -X POST "https://api.modrinth.com/v2/project/$PROJECT_SLUG/version" \
            -H "Authorization: Bearer $MODRINTH_TOKEN" \
            -F "name=$VERSION_NAME" \
            -F "version_number=$VERSION_NAME" \
            -F "changelog=$CHANGELOG" \
            -F "game_versions=$GAME_VERSIONS" \
            -F "loaders=$LOADERS" \
            -F "featured=true" \
            -F "version_type=release" \
            -F "file=@$JAR_FILE")

          echo "Response from Modrinth:"
          echo "$RESPONSE"

          # Получаем URL файла из ответа JSON
          FILE_URL=$(echo "$RESPONSE" | jq -r '.files[0].url')
          if [ -z "$FILE_URL" ] || [ "$FILE_URL" = "null" ]; then
            echo "Error: Failed to get uploaded file URL"
            exit 1
          fi

          echo "Modrinth file URL: $FILE_URL"
          echo "file_url=$FILE_URL" >> $GITHUB_OUTPUT
